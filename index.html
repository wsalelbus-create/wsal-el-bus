<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Live bus tracker for ETUSA Algiers with real-time countdowns">
    <meta name="theme-color" content="#00d2ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ŸàÿµŸÑ ÿßŸÑÿ®ÿßÿµ">
    <meta name="mobile-web-app-capable" content="yes">

    <title>ŸàÿµŸÑ ÿßŸÑÿ®ÿßÿµ - Wsal El Bus</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.webmanifest">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./pwa-mobile.css">
    <link rel="stylesheet" href="./station-modal.css">
    <link rel="stylesheet" href="./version-footer.css">
    <link rel="stylesheet" href="./universal-install.css">
    <link rel="stylesheet" href="./weather-display.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./leaflet.css" />

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="./images/icon16.png">
    <link rel="icon" type="image/png" sizes="48x48" href="./images/icon48.png">
    <link rel="icon" type="image/png" sizes="128x128" href="./images/icon128.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./images/icon192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./images/icon512.png">
    <link rel="apple-touch-icon" href="./images/icon192.png">
</head>

<body>
    <div class="app-container">
        <header class="glass-header">
            <div class="logo-area">
                <h1 class="arabic-title">ŸàÿµŸÑ ÿßŸÑÿ®ÿßÿµ</h1>
                <span class="live-badge">LIVE</span>
            </div>
            <div class="time-display" id="algiers-time">--:--</div>
            <div class="weather-display" id="weather-display">üå§Ô∏è</div>
        </header>

        <main>
            <section class="station-card glass-panel">
                <div class="slider-container">
                    <!-- Slide 1: Station Image -->
                    <div class="slide active" id="slide-image">
                        <div class="station-image-container">
                            <img src="images/station_placeholder.png" alt="Station" id="current-station-img"
                                class="station-img">
                            <div class="station-overlay">
                                <h2 id="station-name">Loading Station...</h2>
                                <p id="station-address" class="address"><span class="icon">üìç</span> <span
                                        id="addr-text">Locating...</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Map View -->
                    <div class="slide" id="slide-map">
                        <div id="map-container"></div>
                        <div class="map-overlay">
                            <h2 id="map-station-name">Loading...</h2>
                            <p class="map-distance" id="map-distance">üìç Calculating distance...</p>
                        </div>
                    </div>

                    <!-- Slider Navigation Dots -->
                    <div class="slider-dots">
                        <span class="dot active" data-slide="0"></span>
                        <span class="dot" data-slide="1"></span>
                    </div>
                </div>
            </section>

            <section class="routes-container">
                <!-- Walking Time Indicator -->
                <div class="walking-time" id="walking-time">
                    <span class="walk-icon">üö∂</span>
                    <span id="walk-time-text">Calculating...</span>
                </div>

                <h3>Next Arrivals</h3>
                <div class="routes-list" id="routes-list">
                    <!-- Route items will be injected here -->
                    <div class="loading-spinner"></div>
                </div>
            </section>
        </main>

        <!-- Station Selector Modal -->
        <div id="station-modal" class="modal-overlay hidden">
            <div class="modal-content glass-panel">
                <div class="modal-header">
                    <h3>Select Station</h3>
                    <button id="close-modal" class="close-btn">‚úï</button>
                </div>
                <input type="text" id="station-search" class="station-search" placeholder="Search stations...">
                <div class="station-list" id="station-list">
                    <!-- Station items will be injected here -->
                </div>
            </div>
        </div>

        <footer class="glass-footer">
            <button id="btn-nearest" class="nav-btn active">Nearest</button>
            <button id="btn-list" class="nav-btn">All Stations</button>
        </footer>

        <!-- Version Footer -->
        <div class="version-footer">
            <div class="version-text">Wsal El Bus 1.10a</div>
            <div class="tagline">Made with ‚ù§Ô∏è for Algiers commuters</div>
        </div>
    </div>

    <!-- Universal Install Button (Always Visible) -->
    <button id="universal-install-btn" class="universal-install-btn">
        üì± Install App
    </button>

    <!-- Install Instructions Modal -->
    <div id="install-modal" class="install-modal hidden">
        <div class="install-modal-content">
            <div class="install-modal-header">
                <h3>üì± Install Wsal El Bus</h3>
                <button id="close-install-modal" class="install-modal-close">‚úï</button>
            </div>

            <div id="install-instructions" class="install-instructions">
                <!-- Instructions will be dynamically inserted based on browser -->
            </div>

            <button id="install-now-btn" class="install-now-btn hidden">Install Now</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./leaflet.js"></script>
    <script src="./weather.js"></script>
    <script src="./app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }

        // Universal Install System - Works on ALL browsers
        let deferredPrompt;
        const universalInstallBtn = document.getElementById('universal-install-btn');
        const installModal = document.getElementById('install-modal');
        const closeInstallModal = document.getElementById('close-install-modal');
        const installInstructions = document.getElementById('install-instructions');
        const installNowBtn = document.getElementById('install-now-btn');

        // Detect browser and device
        function detectBrowserAndDevice() {
            const ua = navigator.userAgent;
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            const isChrome = /Chrome/i.test(ua) && !/Edg/i.test(ua);
            const isSafari = /Safari/i.test(ua) && !/Chrome/i.test(ua);
            const isFirefox = /Firefox/i.test(ua);
            const isMobile = isAndroid || isIOS;

            return { isAndroid, isIOS, isChrome, isSafari, isFirefox, isMobile };
        }

        // Check if desktop - hide button initially, let Chrome show its banner
        const { isMobile } = detectBrowserAndDevice();
        if (!isMobile) {
            universalInstallBtn.classList.add('hidden');
        }

        // Generate install instructions based on browser
        function getInstallInstructions() {
            const { isAndroid, isIOS, isChrome, isSafari, isMobile } = detectBrowserAndDevice();

            if (isIOS && isSafari) {
                return `
                    <div class="install-step">
                        <span class="install-step-number">1</span>
                        <span class="install-step-text">Tap the <strong>Share</strong> button <span class="browser-badge">‚¨ÜÔ∏è</span> at the bottom</span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">2</span>
                        <span class="install-step-text">Scroll and tap <strong>"Add to Home Screen"</strong> <span class="browser-badge">‚ûï</span></span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">3</span>
                        <span class="install-step-text">Tap <strong>"Add"</strong> in the top right</span>
                    </div>
                `;
            } else if (isAndroid && isChrome) {
                return `
                    <div class="install-step">
                        <span class="install-step-number">1</span>
                        <span class="install-step-text">Tap the <strong>menu</strong> button <span class="browser-badge">‚ãÆ</span> in the top right</span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">2</span>
                        <span class="install-step-text">Select <strong>"Add to Home screen"</strong> (works on all devices)</span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">3</span>
                        <span class="install-step-text">Tap <strong>"Add"</strong> to create the app shortcut</span>
                    </div>
                `;
            } else if (isAndroid) {
                // Check if it's Android Go (low RAM device)
                const isLowRAM = navigator.deviceMemory && navigator.deviceMemory <= 2;

                if (isLowRAM) {
                    return `
                        <div class="install-step">
                            <span class="install-step-text" style="color: var(--accent-color); margin-bottom: 10px; display: block;">
                                <strong>üì± Your device uses Android Go Edition</strong>
                            </span>
                        </div>
                        <div class="install-step">
                            <span class="install-step-number">1</span>
                            <span class="install-step-text"><strong>Bookmark this page</strong> for quick access</span>
                        </div>
                        <div class="install-step">
                            <span class="install-step-number">2</span>
                            <span class="install-step-text">Tap <strong>‚ãÆ</strong> menu ‚Üí <strong>‚≠ê Bookmark</strong></span>
                        </div>
                        <div class="install-step">
                            <span class="install-step-number">3</span>
                            <span class="install-step-text">Access from bookmarks anytime - works offline!</span>
                        </div>
                    `;
                }

                return `
                    <div class="install-step">
                        <span class="install-step-number">1</span>
                        <span class="install-step-text">Tap the <strong>menu</strong> button <span class="browser-badge">‚ãÆ</span></span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">2</span>
                        <span class="install-step-text">Select <strong>"Add to Home screen"</strong></span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">3</span>
                        <span class="install-step-text">Confirm to add the shortcut</span>
                    </div>
                `;
            } else {
                // Desktop
                return `
                    <div class="install-step">
                        <span class="install-step-number">1</span>
                        <span class="install-step-text">Look for the <strong>install icon</strong> <span class="browser-badge">‚äï</span> in the address bar</span>
                    </div>
                    <div class="install-step">
                        <span class="install-step-number">2</span>
                        <span class="install-step-text">Or click the button below to install directly</span>
                    </div>
                `;
            }
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéâ beforeinstallprompt event fired!');
            deferredPrompt = e;

            // Desktop: Don't prevent default - let Chrome show its banner
            // Mobile: Show our custom button since native options may be limited
            if (isMobile) {
                e.preventDefault();
                universalInstallBtn.classList.remove('hidden');
            }

            // Show the "Install Now" button in modal for both
            installNowBtn.classList.remove('hidden');
        });

        // Universal install button click
        universalInstallBtn.addEventListener('click', () => {
            installInstructions.innerHTML = getInstallInstructions();
            installModal.classList.remove('hidden');
        });

        // Close modal
        closeInstallModal.addEventListener('click', () => {
            installModal.classList.add('hidden');
        });

        // Click outside modal to close
        installModal.addEventListener('click', (e) => {
            if (e.target === installModal) {
                installModal.classList.add('hidden');
            }
        });

        // Install Now button (only shows if beforeinstallprompt fired)
        installNowBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                if (outcome === 'accepted') {
                    installModal.classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // Log when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed successfully');
            universalInstallBtn.classList.add('hidden');
            installModal.classList.add('hidden');
        });

        // Check if app is already installed (on page load)
        if (window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true) {
            console.log('‚úÖ App is running in standalone mode (already installed)');
            universalInstallBtn.classList.add('hidden');
        }
    </script>
</body>

</html>